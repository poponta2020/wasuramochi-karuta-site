# 要件定義書：活動報告機能の改善

**作成日**: 2026年2月4日
**プロジェクト**: わすらもち会 公式サイト
**バージョン**: 1.0

---

## 1. 概要

### 1.1 背景
現在、活動報告はindex.htmlに直接HTMLを記述して管理している。今後活動報告が増えていくと以下の問題が発生する：
- ページが縦に長くなり、ユーザー体験が悪化する
- HTMLを直接編集する必要があり、更新の手間がかかる

### 1.2 目的
1. 活動報告の履歴増加によるページ肥大化を防ぐ
2. HTMLを直接編集せずに、UIから活動報告を更新できるようにする

---

## 2. 機能要件

### 2.1 活動報告ページの分離

| 項目 | 内容 |
|------|------|
| トップページ（index.html） | 最新3件を表示 + 「もっと見る」リンク |
| 活動報告一覧ページ | 新規作成（`/reports.html`） |
| ページネーション | 6件/ページ |
| 並び順 | 日付の新しい順 |

### 2.2 管理画面機能

| 機能 | 詳細 |
|------|------|
| 認証 | パスワードのみの簡易認証 |
| 記事作成 | タイトル、日付、本文、画像（複数）を入力 |
| 記事編集 | 既存の活動報告を編集 |
| 記事削除 | 活動報告を削除 |
| 画像アップロード | ファイル選択またはドラッグ&ドロップでアップロード（スマホからはカメラロール選択可） |
| プレビュー | 公開前に表示を確認 |

### 2.3 データ項目

1件の活動報告に含まれる情報：

| フィールド | 型 | 説明 |
|------------|------|------|
| id | UUID | 一意識別子（自動生成） |
| date | string | 表示用日付（例: "2025.08.23"） |
| title | string | タイトル |
| description | string | 説明文 |
| images | string[] | 画像URLの配列（複数可） |
| created_at | timestamp | 作成日時（自動生成） |
| updated_at | timestamp | 更新日時（自動更新） |

---

## 3. 非機能要件

### 3.1 パフォーマンス
- ページ読み込み時間：3秒以内（画像除く）
- 画像は遅延読み込み（Lazy Loading）を適用

### 3.2 対応デバイス
- PC（Chrome, Firefox, Safari, Edge）
- スマートフォン（iOS Safari, Android Chrome）

### 3.3 アクセシビリティ
- 画像にはalt属性を設定可能にする
- キーボード操作に対応

---

## 4. 技術構成

### 4.1 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                      ユーザー                            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                  Netlify (ホスティング)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │ index.html  │  │ reports.html│  │ admin/index.html│  │
│  │ (トップ)    │  │ (一覧)      │  │ (管理画面)      │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              ▼                           ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│   Supabase (データベース) │   │  Cloudinary (画像CDN)   │
│   - 活動報告データ        │   │  - 画像保存・配信       │
│   - 認証情報             │   │  - 自動最適化          │
└─────────────────────────┘   └─────────────────────────┘
```

### 4.2 技術スタック

| レイヤー | サービス/技術 | 用途 |
|----------|---------------|------|
| フロントエンド | HTML/CSS/JavaScript（Vanilla） | 公開サイト・管理画面 |
| データベース | Supabase（PostgreSQL） | 活動報告データの保存 |
| 画像ストレージ | Cloudinary | 画像のアップロード・配信 |
| ホスティング | Netlify | サイト配信（現状維持） |

### 4.3 ファイル構成

```
wasuramochi-karuta-site/
├── index.html              # 既存：最新3件 + リンク表示に変更
├── reports.html            # 新規：活動報告一覧ページ
├── admin/
│   └── index.html          # 新規：管理画面
├── js/
│   ├── config.js           # 新規：設定（API Keyなど）
│   ├── reports.js          # 新規：活動報告の取得・表示
│   └── admin.js            # 新規：管理画面ロジック
├── css/
│   └── admin.css           # 新規：管理画面用スタイル
├── style.css               # 既存：スタイル追加
└── docs/
    └── requirements-activity-reports.md  # 本ファイル
```

---

## 5. 外部サービス設定

### 5.1 Supabase（データベース）

#### 必要な作業
1. Supabaseアカウント作成（https://supabase.com）
2. 新規プロジェクト作成
3. `reports`テーブル作成（以下のスキーマ）
4. Row Level Security (RLS) 設定
5. API URL・anon key取得

#### テーブルスキーマ

```sql
CREATE TABLE reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  date VARCHAR(20) NOT NULL,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  images TEXT[] DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 更新日時の自動更新
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER reports_updated_at
  BEFORE UPDATE ON reports
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

#### RLS設定

```sql
-- RLSを有効化
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- 読み取りは全員可能
CREATE POLICY "Public read access" ON reports
  FOR SELECT USING (true);

-- 書き込みは認証済みユーザーのみ
CREATE POLICY "Authenticated write access" ON reports
  FOR ALL USING (auth.role() = 'authenticated');
```

### 5.2 Cloudinary（画像ホスティング）

#### 必要な作業
1. Cloudinaryアカウント作成（https://cloudinary.com）
2. Upload Preset作成（Settings → Upload → Upload presets → Add upload preset）
   - Signing Mode: **Unsigned**
   - Folder: `wasuramochi-reports`
3. 以下の情報を取得：
   - Cloud Name
   - Upload Preset名

---

## 6. 画面仕様

### 6.1 トップページ（index.html）活動報告セクション

**変更内容：**
- 現在の4件固定表示 → 最新3件を動的に表示
- 「もっと見る」ボタンを追加（reports.htmlへリンク）

**表示要素：**
- イベントカード（現在と同じデザイン）
- 各カードに画像カルーセル機能を維持
- 「もっと見る」ボタン

### 6.2 活動報告一覧ページ（reports.html）

**表示要素：**
- ページタイトル「活動報告」
- イベントカード一覧（6件/ページ）
- ページネーション（前へ/次へ、ページ番号）
- トップページへ戻るリンク

**レイアウト：**
- PC: 2列グリッド
- スマホ: 1列

### 6.3 管理画面（admin/index.html）

**画面構成：**

1. **ログイン画面**
   - パスワード入力フィールド
   - ログインボタン

2. **ダッシュボード**
   - 新規作成ボタン
   - 活動報告一覧（編集・削除ボタン付き）

3. **編集画面**
   - 日付入力（date picker）
   - タイトル入力
   - 説明文入力（textarea）
   - 画像アップロードエリア
     - ドラッグ&ドロップ対応
     - 「ファイルを選択」ボタン
     - アップロード済み画像のプレビュー・削除
   - 保存ボタン / キャンセルボタン

---

## 7. セキュリティ

### 7.1 認証方式

簡易パスワード認証を採用：
- 管理画面アクセス時にパスワード入力を要求
- パスワードはSupabaseの環境変数または設定テーブルで管理
- セッションはブラウザのlocalStorageで管理

### 7.2 リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| APIキーの露出 | 中 | RLSで書き込み権限を制限 |
| パスワードの漏洩 | 中 | 定期的なパスワード変更を推奨 |
| 不正な画像アップロード | 低 | Cloudinaryのファイル形式制限を設定 |

### 7.3 注意事項

> **重要**: 静的サイトのため、フロントエンドのJavaScriptに含まれるAPIキーは完全に隠蔽できません。
> 本格的なセキュリティが必要な場合は、サーバーサイド認証（Netlify Functions等）の導入を検討してください。

---

## 8. 無料枠の確認

| サービス | 無料枠 | 想定使用量 | 判定 |
|----------|--------|------------|------|
| Supabase | 500MB DB, 50,000行, 2プロジェクト | 数百件程度 | ✅ 十分 |
| Cloudinary | 25GB, 25,000変換/月 | 月10枚程度 | ✅ 十分 |
| Netlify | 100GB転送/月, 300分ビルド/月 | 小規模サイト | ✅ 十分 |

---

## 9. 移行計画

### 9.1 既存データの移行

現在index.htmlにハードコーディングされている4件の活動報告をSupabaseに移行する。

| 日付 | タイトル |
|------|----------|
| 2025.08.23 | 第32回多摩大会B級 優勝！ |
| 2025.06.29 | 第78回福井大会B級 4位入賞 |
| 2025.06.11 | 新Tシャツお披露目 |
| 2024.10.12~ | 円山合宿 2024 |

### 9.2 画像の移行

既存の画像（`/images/`フォルダ内）は以下のいずれかで対応：
1. Cloudinaryに再アップロード（推奨）
2. 既存パスをそのまま使用（移行コスト低）

---

## 10. 今後の拡張性

本要件で対応しないが、将来的に検討可能な機能：

- [ ] カテゴリ・タグ機能
- [ ] 検索機能
- [ ] SNSシェアボタン
- [ ] コメント機能
- [ ] 複数管理者対応
- [ ] 下書き保存機能

---

## 11. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| 作成者 | - | 2026/02/04 | - |
| 承認者 | - | - | - |

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/02/04 | 初版作成 |
